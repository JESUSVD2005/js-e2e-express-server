# azure-pipelines.yml

# 1. Stage de Construcción (Build)
stages:
- stage: Build
  displayName: 'Build and Test Node.js App'
  jobs:
  - job: BuildJob
    displayName: 'Build, Test, and Publish Artifacts'
    pool:
      vmImage: ubuntu-latest
    
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js 20.x'

    - script: |
        npm install
        npm run build 
      displayName: 'npm install and build'

    - script: |
        npm test
      displayName: 'Run Tests'

    # Usa la tarea PublishPipelineArtifact@1 para publicar los archivos de build
    - task: PublishPipelineArtifact@1
      inputs:
        artifactName: 'nodejs-app' # Nombre del artefacto para el despliegue
        # La ruta donde se encuentran tus archivos de build después de 'npm run build'
        targetPath: '$(Build.SourcesDirectory)' 
      displayName: 'Publish pipeline artifact'

# --- FIN DE LA ETAPA DE CONSTRUCCIÓN ---

# 2. Stage de Despliegue (Deployment)

- stage: Deploy
  displayName: 'Deploy to Azure App Service'
  dependsOn: Build # Esta etapa SOLO se ejecuta si la etapa 'Build' fue exitosa
  condition: succeeded() 
  
  jobs:
  - deployment: DeploymentJob
    displayName: 'Deployment Job'
    # Puedes usar 'vmImage' si no usas Environments
    pool:
      vmImage: 'ubuntu-latest' 

    strategy:
      runOnce:
        deploy:
          steps:
          
          # Descarga el artefacto 'nodejs-app' generado en la etapa anterior
          - task: DownloadPipelineArtifact@2
            inputs:
              artifactName: 'nodejs-app'
              targetPath: '$(Pipeline.Workspace)/nodejs-app'
            displayName: 'Download Build Artifacts'

          # Tarea clave: Despliega el contenido en Azure App Service
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure App Service'
            inputs:
              # ******** TU SERVICE CONNECTION *********
              azureSubscription: 'inges7c' # Nombre de la conexión de tu imagen
              appName: 'RecursosWebs'          # Nombre del App Service de tu imagen
              package: '$(Pipeline.Workspace)/nodejs-app'
              # runtimeStack: 'NODE|20-lts' # Opcional: especificar la versión de Node.js en el App Service